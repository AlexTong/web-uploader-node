//devin87@qq.com
//build:2014/09/24 15:30:33
(function(t,l){function u(a,b){var c=a.lastIndexOf(b);return-1!=c?a.slice(c):""}function v(a){if(a){a=a.split(",");for(var b={},c=0,d=a.length;c<d;c++)b[a[c]]=!0;return b}}function A(a,b){a.attachEvent?a.attachEvent("onload",b):a.addEventListener("load",b,!1)}function h(a){this.guid=a.guid||"uploader"+ ++B;this.url=a.url;this.dataType=a.dataType||"json";this.data=a.data;this.target=a.target;this.html5=m&&!!p(a.html5,!0);this.multiple=q&&this.html5&&!!p(a.multiple,!0);this.clickTrigger=w&&!!p(a.clickTrigger,
!0);this.workerIdle=this.workerThread=this.html5?a.workerThread||1:1;this.auto=!1!==a.auto;this.upName=a.upName||"upfile";this.allows=v(a.allows);this.disallows=v(a.disallows);this.container=a.container||document.body;a.getPos&&(this.getPos=a.getPos);var b=a.UI||{};b.init&&(this.init=b.init);b.draw&&(this.draw=b.draw);b.update&&(this.update=b.update);b.over&&(this.over=b.over);this.fns=a.on||{};this.ops=a;this.list=[];this.map={};this.index=0;this.started=!1;this._init()}var p=Q.def,n=Q.fire,x=Q.extend,
y=Q.getFirst,C=Q.getLast,D=JSON.parse,z=Q.createEle,E=Q.parseHTML,F=Q.setOpacity,G=Q.getOffset,r=Q.Event,s=r.add,H=r.fire,I=r.stop,m=!1,q=!1,w=!1,B=0,J=0,K=0;h.prototype={constructor:h,_init:function(){var a=this;if(!a._inited){a._inited=!0;var b=a.guid,c=a.target,d=a.container,f=z("div","upload-input "+b);d.appendChild(f);a.boxInput=f;if(!a.html5){var e="upload_iframe_"+b,b=z("div","upload-html4 "+b,'<iframe class="u-iframe" name="'+e+'"></iframe><form class="u-form" action="" method="post" enctype="multipart/form-data" target="'+
e+'"></form>');d.appendChild(b);var g=y(b),d=C(b);a.iframe=g;a.form=d;A(g,function(){if(0==a.workerIdle){var b;try{b=g.contentWindow.document.body.innerHTML}catch(c){}a.complete(l,2,b)}})}a.clickTrigger?s(c,"click",function(b){!1!==a.fire("select",b)&&(a.resetInput(),H(a.inputFile,"click"))}):(s(f,"click",function(b){!1===a.fire("select",b)&&I(b)}),F(f,0),a.resetInput());a.fire("init");return a.run("init")}},resetInput:function(){var a=this,b=a.boxInput,c=a.target,d=c.offsetWidth,c=c.offsetHeight;
b.innerHTML='<input type="file" name="'+a.upName+'" style="'+(a.clickTrigger?"visibility: hidden;":"width:"+d+"px;height:"+c+"px;font-size:100px;")+'"'+(a.multiple?' multiple="multiple"':"")+">";b.style.width=d+"px";b.style.height=c+"px";b=y(b);s(b,"change",function(b){a.add(this);a.html5||a.resetInput()});a.inputFile=b;a.updatePos();return a},updatePos:function(a){if(!this.clickTrigger){var b=this.getPos||G,c=this.boxInput,d=this.target,b=0==d.offsetWidth?{left:-1E4,top:-1E4}:b(d);c.style.left=b.left+
"px";c.style.top=b.top+"px";a&&(c.style.zIndex=++K)}},fire:function(a,b,c){if(!c)return n(this.fns[a],this,b);var d=this.fns[a+"Async"];if(d)return n(d,this,b,c);c(n(this.fns[a],this,b))},run:function(a,b){var c=this[a];c&&n(c,this,b);return this},addTask:function(a,b,c){if(a||b){var d,f;b?(d=b.name||b.fileName,f=b.size||b.fileSize):(d=u(a.value,"\\").slice(1)||a.value,f=-1);var e=this,g=u(d,".").toLowerCase(),h=e.disallows&&e.disallows[g]||e.allows&&!e.allows[g],k={id:++J,name:d,ext:g,size:f,input:a,
file:b,arg:c,state:h?-1:0};h&&(k.disabled=!0);e.fire("add",k,function(a){!1===a||k.disabled||(k.index=e.list.length,e.list.push(k),e.map[k.id]=k,e.run("draw",k),e.auto&&e.start())});return k}},add:function(a){if("INPUT"==a.tagName){var b=a.files;if(b)for(var c=0,d=b.length;c<d;c++)this.addTask(a,b[c]);else this.addTask(a)}else this.addTask(l,a)},addList:function(a){for(var b=0,c=a.length;b<c;b++)this.add(a[b])},get:function(a){if(a!=l)return this.map[a]},cancel:function(a){if(a=this.get(a)){var b=
a.state;if(0!=b&&1!=b)return this;if(1==b){if(b=a.xhr)return b.abort(),this;this.iframe.contentWindow.location="about:blank"}return this.complete(a,-2)}},remove:function(a){var b=this.get(a);b&&(1==b.state&&this.cancel(a),b.deleted=!0,this.fire("remove",b))},start:function(){var a=this.workerIdle,b=this.list,c=this.index,d=b.length;this.started||(this.started=!0);if(0>=d||c>=d||0>=a)return this;a=b[c];this.index++;return this.upload(a)},upload:function(a){var b=this;if(!a||0!=a.state)return b.start();
a.url=b.url;b.workerIdle--;b.fire("upload",a,function(c){if(!1===c)return b.complete(a,-1);b.html5&&a.file?b._upload_html5(a):a.input?b._upload_html4(a):b.complete(a,-1)});return b},_process_params:function(a,b){this.data&&Object.forEach(this.data,b);a.data&&Object.forEach(a.data,b)},_upload_html5:function(a){var b=this,c=new XMLHttpRequest;a.xhr=c;c.upload.addEventListener("progress",function(c){b.progress(a,c.total,c.loaded)},!1);c.addEventListener("load",function(c){b.complete(a,2,c.target.responseText)},
!1);c.addEventListener("error",function(){b.complete(a,-3)},!1);c.addEventListener("abort",function(){b.complete(a,-2)},!1);var d=new FormData;b._process_params(a,function(a,b){d.append(a,b)});d.append(b.upName,a.file);c.open("POST",a.url);c.setRequestHeader("X-Requested-With","XMLHttpRequest");b.fire("send",a,function(f){if(!1===f)return b.complete(a,-1);c.send(d);b._afterSend(a)})},_upload_html4:function(a){var b=this,c=b.form,d=a.input;if(d._uploaded)return b.complete(a,2);d._uploaded=!0;d.name=
b.upName;c.innerHTML="";c.appendChild(d);c.action=a.url;b._process_params(a,function(a,b){c.appendChild(E('<input type="hidden" name="'+a+'" value="'+b+'">'))});b.fire("send",a,function(d){if(!1===d)return b.complete(a,-1);c.submit();b._afterSend(a)})},_afterSend:function(a){a.time=a.timeStart=Date.now();a.state=1;this._lastTask=a;this.progress(a)},progress:function(a,b,c){b||(b=a.size);if(!c||0>c)c=0;var d=a.state||0;c>b&&(c=b);0<c&&0==d&&(a.state=d=1);2==d&&(b=c=a.size);var d=b,f=c;if(d&&!(0>=d)){var e=
Date.now(),g;if(f>=d){if(g=e-a.timeStart)a.avg_speed=Math.min(Math.round(1E3*d/g),d);a.timeEnd=e}else g=e-a.time,200>g||(a.speed=Math.min(Math.round(1E3*(f-a.loaded)/g),a.total),a.time=e)}a.total=b;a.loaded=c;this.fire("progress",a);this.run("update",a)},_process_response:function(a,b){(a.response=b)&&"json"==this.dataType&&(a.json=D(b))},complete:function(a,b,c){a||1!=this.workerThread||(a=this._lastTask);a&&(b!=l&&(a.state=b),1==a.state&&(a.state=2,this.progress(a,a.size,a.size)),c!==l&&this._process_response(a,
c));-2==b&&this.fire("cancel",a);this.fire("complete",a);this.run("over",a).run("update",a);this.workerIdle++;this.started&&this.start();return this}};h.extend=function(a,b){x(h.prototype,a,b)};(function(){var a=t.XMLHttpRequest;a&&(new a).upload&&t.FormData&&(m=!0);a=document.createElement("input");a.type="file";q=!!a.files;w=m})();x(h,{support:{html5:m,multiple:q},READY:0,PROCESSING:1,COMPLETE:2,SKIP:-1,CANCEL:-2,ERROR:-3,getStatusText:function(a){switch(a){case 0:return"\u51c6\u5907\u4e2d";case 1:return"\u4e0a\u4f20\u4e2d";
case 2:return"\u5df2\u5b8c\u6210";case -1:return"\u5df2\u8df3\u8fc7";case -2:return"\u5df2\u53d6\u6d88";case -3:return"\u5df2\u5931\u8d25"}return a}});Q.Uploader=h})(window);
